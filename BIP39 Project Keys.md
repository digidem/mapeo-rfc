# Decoding project keys from BIP39 phrases

## Summary

The goal of this proposal is to create a short-term solution that enables users
to join a project without needing to download and install a `.mapeosettings`
file. The proposal is to encode project keys as [BIP39
phrases](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki),
allowing the user to enter a 24-word BIP39 phrase in settings screen of Mapeo
Mobile in order to join a project.

## Why is this needed?

Mapeo Mobile uses a 32-byte (256-bit) random number as a project key. The
project key is used to ensure that devices trying to sync will only see other
devices with the same project key, and it is used to encrypt synchronization
between two devices.

Currently this project key is generated by a project coordinator who creates a
[`.mapeosettings`](https://github.com/digidem/mapeo-settings-builder) file which
includes a randomly generated project key, and this file is added to each device
via the settings screen in Mapeo Mobile: the user selects the `.mapeosettings`
file and Mapeo imports the key.

For some users with low technical literacy, the process of moving a
`.mapeosettings` file onto a phone and importing it is too complicated. This is
particularly the case for users without access to the internet: it requires
either side-loading the file via a computer connected with USB, which may
require drivers to be installed, special configuration of the phone (to enable
file transfer over USB) and does not work reliably with Samsung phones (which
require special "smart sync" software). It is also possible to load via a USB
thumb drive connected to the phone via a USB OTG cable, or via a USB thumb drive
with a micro-USB or USB-C connector. This requires the user to have the
necessary hardware, and it also requires the phone to have an app installed that
gives access to the phones filesystem. This is not always the case, particularly
on phones prior to Android 8.0. Even when the user can access the filesystem, on
some phones Android presents a virtualized filesystem to the user which is
inconsistent with what is viewable to Mapeo itself: e.g. the user may put the
file in the "Downloads" folder, but it is not visible in the "Downloads" folder
that is visible from Mapeo when the user tries to select the file. This is
particularly important in the context of the current Covid-19 pandemic, which
restricts in-person technical support of end-users.

We plan to implement a project invite workflow, which uses QR codes or some
other mechanism to easily add new users to a project and securely share a
project key. However, this work is not yet funded and may not be done for
several months.

For short-term needs (within 3-4 months, e.g. by September) we need an easy way
for users to share a project key. One option is to manually enter the project
key, but as a hex-encoded string this is 64-characters long, and the chance of
input errors is high, and there would be no way to validate that the key had
been entered correctly other than trying to sync, at which point it would be
unclear which of two parties had the correct/incorrect key of if they both had
entered it incorrectly.

## Proposal

[BIP39](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki) is a
spec for encoding and decoding random numbers with 128–256 bits of entropy as
list of words. The words are selected to avoid similar words. The spec includes
word list for English, Japanese, Korean, Spanish, Chinese (Simplified), Chinese
(Traditional), French, Italian, Czech. BIP39 uses the last word in the list as a
checksum. BIP39 can encode any random 128–256 bit number as a 12–24 word phrase.

This proposal is to encode a project key as a 24-word phrase using BIP39, and
add a settings screen to Mapeo Mobile that allows the user to join a project by
entering this phrase. The phrase input field should validate the phrase and
provide feedback if the checksum is invalid, so that the user can correct any
input errors.

The objective of this approach is to provide a way for users to enter a project
key manually in a way that is not prone to errors.

## Limitations and vulnerabilities

Similar to the project key in the `.mapeosettings` file, the 24-word phrase
grants access to anybody with the phrase to decrypt local network traffic when
syncing a project (and online traffic once Mapeo Web is deployed). It needs to
be treated as a secure password and kept secure.

BIP39 wordlists are in a limited number of languages. Users who speak other
languages would need to use a passphrase in a language they do not speak (e.g.
Thai users could use an English pass phrase).

Joining a project via a pass phrase does not allow the user to change the
categories and icons that they can select when adding an observation to Mapeo
Mobile. Any user joining a project this way would need to use the [default
categories and icons](https://github.com/digidem/mapeo-default-config) that are
available in the general download of Mapeo.

We could add a feature for any device that is part of the project to display the
project key as a pass phrase. This would make it easier for a user to grant a
new user access to a project, however this would be a vulnerability if a project
member chose to or was forced to show their phone to an attacker, who could
easily see the pass phrase to access the project. This vulnerability is still
there for a more sophisticated attacker with the current `.mapeosettings` file
import, since it is stored in shared storage on the device, so is accessible to
anybody through the phone filesystem. This data could be moved to the sandboxed
app storage, which would make it inaccessible from outside the app unless the
phone is rooted (e.g. the bootloader and firmware is modified to give root
access).

## Workflow ideas

1. A user with internet access receives a pass phrase via a secure channel, e.g.
   Signal or WhatsApp.
2. The user copies (digital copy-paste) or writes down the pass phrase.
3. The user pastes or types in the pass phrase into Mapeo.
    1. The pass phrase is entered incorrectly: Mapeo shows an error
    2. The pass phrase is entered correctly: Mapeo saves the project key and
       joins the project.
4. The user travels to other users and shows them the pass phrase, which they
   enter into their installations of Mapeo.
